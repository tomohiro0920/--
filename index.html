<!-- fortune-app.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”® ä»Šæ—¥ã®é‹å‹¢å ã„</title>
<style>
  /* === ãƒªã‚»ãƒƒãƒˆãƒ»ãƒ™ãƒ¼ã‚¹ === */
  *, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --primary: #6c5ce7;
    --primary-dark: #4a3db8;
    --accent: #fd79a8;
    --bg-start: #0c0020;
    --bg-mid: #1a0040;
    --bg-end: #0d0030;
    --card-bg: rgba(255, 255, 255, 0.06);
    --card-border: rgba(255, 255, 255, 0.1);
    --text: #f0e6ff;
    --text-muted: rgba(240, 230, 255, 0.5);
    --success: #00b894;
    --warning: #fdcb6e;
    --error: #e17055;
  }

  body {
    font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background: linear-gradient(160deg, var(--bg-start) 0%, var(--bg-mid) 50%, var(--bg-end) 100%);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    overflow-x: hidden;
  }

  /* === èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« === */
  body::before {
    content: "";
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image:
      radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,0.3), transparent),
      radial-gradient(2px 2px at 40% 70%, rgba(255,255,255,0.2), transparent),
      radial-gradient(1px 1px at 60% 20%, rgba(255,255,255,0.4), transparent),
      radial-gradient(1px 1px at 80% 50%, rgba(255,255,255,0.2), transparent),
      radial-gradient(2px 2px at 10% 80%, rgba(255,255,255,0.15), transparent),
      radial-gradient(1px 1px at 70% 90%, rgba(255,255,255,0.3), transparent),
      radial-gradient(2px 2px at 90% 10%, rgba(255,255,255,0.2), transparent),
      radial-gradient(1px 1px at 50% 50%, rgba(255,255,255,0.25), transparent);
    background-size: 300px 300px;
    animation: twinkle 8s ease-in-out infinite alternate;
    pointer-events: none;
    z-index: 0;
  }

  @keyframes twinkle {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  /* === ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ === */
  .container {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 480px;
  }

  /* === ãƒ˜ãƒƒãƒ€ãƒ¼ === */
  .header {
    text-align: center;
    margin-bottom: 32px;
  }

  .header-icon {
    font-size: 56px;
    display: block;
    margin-bottom: 12px;
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .header h1 {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(135deg, #a29bfe, #fd79a8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 2px;
  }

  .header p {
    color: var(--text-muted);
    font-size: 14px;
    margin-top: 8px;
  }

  /* === ã‚«ãƒ¼ãƒ‰ === */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    padding: 32px 28px;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    margin-bottom: 16px;
    transition: transform 0.3s, box-shadow 0.3s;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 40px rgba(108, 92, 231, 0.15);
  }

  /* === å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  === */
  .input-group {
    margin-bottom: 24px;
  }

  .input-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 10px;
  }

  .input-wrapper {
    position: relative;
  }

  .input-wrapper input {
    width: 100%;
    padding: 14px 18px 14px 48px;
    background: rgba(255, 255, 255, 0.07);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    color: var(--text);
    font-size: 16px;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  .input-wrapper input::placeholder {
    color: rgba(255, 255, 255, 0.25);
  }

  .input-wrapper input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.25);
  }

  .input-wrapper .input-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    opacity: 0.5;
  }

  .validation-msg {
    color: var(--error);
    font-size: 12px;
    margin-top: 6px;
    display: none;
  }

  .validation-msg.show {
    display: block;
  }

  /* === ãƒœã‚¿ãƒ³ === */
  .btn-fortune {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border: none;
    border-radius: 14px;
    color: #fff;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    letter-spacing: 2px;
    transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
    position: relative;
    overflow: hidden;
  }

  .btn-fortune::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .btn-fortune:hover::before {
    opacity: 1;
  }

  .btn-fortune:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(108, 92, 231, 0.4);
  }

  .btn-fortune:active {
    transform: translateY(0);
  }

  .btn-fortune:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .btn-fortune:disabled:hover::before {
    opacity: 0;
  }

  /* === ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° === */
  .loading {
    display: none;
    text-align: center;
    padding: 40px 0;
  }

  .loading.show {
    display: block;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 3px solid rgba(255,255,255,0.1);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading p {
    color: var(--text-muted);
    font-size: 14px;
  }

  /* === çµæœè¡¨ç¤º === */
  .result-area {
    display: none;
  }

  .result-area.show {
    display: block;
    animation: fadeInUp 0.6s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .result-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    padding: 36px 28px;
    backdrop-filter: blur(20px);
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .result-card::before {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
    background-size: 200% 100%;
    animation: shimmer 2s linear infinite;
  }

  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  .result-label {
    font-size: 13px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 3px;
    margin-bottom: 16px;
  }

  .fortune-level {
    font-size: 56px;
    font-weight: 800;
    margin: 12px 0;
    animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  @keyframes popIn {
    0% { transform: scale(0); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }

  .fortune-emoji {
    font-size: 40px;
    display: block;
    margin-bottom: 8px;
  }

  .fortune-message {
    font-size: 16px;
    line-height: 1.8;
    color: rgba(240, 230, 255, 0.8);
    margin: 20px 0;
    padding: 0 8px;
  }

  .fortune-details {
    display: flex;
    justify-content: center;
    gap: 32px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid rgba(255,255,255,0.08);
  }

  .fortune-detail-item {
    text-align: center;
  }

  .fortune-detail-item .detail-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }

  .fortune-detail-item .detail-value {
    font-size: 18px;
    font-weight: 600;
  }

  .color-dot {
    display: inline-block;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 6px;
    border: 1px solid rgba(255,255,255,0.2);
  }

  /* === ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ === */
  .status-bar {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 14px;
    padding: 16px 20px;
    backdrop-filter: blur(20px);
    margin-top: 16px;
  }

  .status-bar h3 {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 12px;
  }

  .status-items {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .status-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 13px;
  }

  .status-item .label {
    color: var(--text-muted);
  }

  .status-badge {
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
  }

  .status-badge.pending {
    background: rgba(253, 203, 110, 0.15);
    color: var(--warning);
  }

  .status-badge.success {
    background: rgba(0, 184, 148, 0.15);
    color: var(--success);
  }

  .status-badge.error {
    background: rgba(225, 112, 85, 0.15);
    color: var(--error);
  }

  /* === ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ === */
  .btn-retry {
    display: none;
    width: 100%;
    padding: 14px;
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 12px;
    color: var(--text);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 16px;
    transition: background 0.2s;
  }

  .btn-retry.show {
    display: block;
  }

  .btn-retry:hover {
    background: rgba(255,255,255,0.12);
  }

  /* === ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– === */
  @media (max-width: 500px) {
    .card, .result-card, .status-bar {
      padding: 24px 20px;
    }
    .header h1 {
      font-size: 22px;
    }
    .fortune-level {
      font-size: 44px;
    }
    .fortune-details {
      gap: 20px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <span class="header-icon">ğŸ”®</span>
    <h1>ä»Šæ—¥ã®é‹å‹¢å ã„</h1>
    <p>åå‰ã‚’å…¥åŠ›ã—ã¦ã€ä»Šæ—¥ã®é‹å‹¢ã‚’å ã„ã¾ã—ã‚‡ã†</p>
  </div>

  <!-- å…¥åŠ›ã‚«ãƒ¼ãƒ‰ -->
  <div class="card" id="inputCard">
    <div class="input-group">
      <label for="nameInput">ã‚ãªãŸã®åå‰</label>
      <div class="input-wrapper">
        <span class="input-icon">âœ¨</span>
        <input type="text" id="nameInput" placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" autocomplete="off" />
      </div>
      <p class="validation-msg" id="validationMsg">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
    </div>
    <button class="btn-fortune" id="fortuneBtn" onclick="main()">ğŸ”® å ã†</button>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>æ˜Ÿã®å°ãã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™...</p>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div class="result-area" id="resultArea">
    <div class="result-card">
      <p class="result-label">âœ¦ æœ¬æ—¥ã®é‹å‹¢ âœ¦</p>
      <span class="fortune-emoji" id="fortuneEmoji"></span>
      <div class="fortune-level" id="fortuneLevel"></div>
      <p class="fortune-message" id="fortuneMessage"></p>
      <div class="fortune-details">
        <div class="fortune-detail-item">
          <p class="detail-label">ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼</p>
          <p class="detail-value" id="luckyColor"></p>
        </div>
        <div class="fortune-detail-item">
          <p class="detail-label">ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼</p>
          <p class="detail-value" id="luckyNumber"></p>
        </div>
        <div class="fortune-detail-item">
          <p class="detail-label">ãƒ©ãƒƒã‚­ãƒ¼æ–¹è§’</p>
          <p class="detail-value" id="luckyDirection"></p>
        </div>
      </div>
    </div>
    <button class="btn-retry" id="retryBtn" onclick="retry()">ğŸ”„ ã‚‚ã†ä¸€åº¦å ã†</button>
  </div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
  <div class="status-bar">
    <h3>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
    <div class="status-items">
      <div class="status-item">
        <span class="label">IPã‚¢ãƒ‰ãƒ¬ã‚¹</span>
        <span class="status-badge pending" id="statusIp">å–å¾—ä¸­...</span>
      </div>
      <div class="status-item">
        <span class="label">ä½ç½®æƒ…å ±</span>
        <span class="status-badge pending" id="statusGeo">å¾…æ©Ÿä¸­</span>
      </div>
      <div class="status-item">
        <span class="label">ãƒ‡ãƒ¼ã‚¿é€ä¿¡</span>
        <span class="status-badge pending" id="statusSubmit">æœªé€ä¿¡</span>
      </div>
    </div>
  </div>
</div>

<script>
  // ============================
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
  // ============================
  /** @type {string|null} */
  let ipAddress = null;

  // ============================
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸æ›´æ–°ãƒ˜ãƒ«ãƒ‘ãƒ¼
  // ============================
  /**
   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆã¨ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°ã™ã‚‹
   * @param {string} id - è¦ç´ ID
   * @param {string} text - è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ
   * @param {"pending"|"success"|"error"} type - ãƒãƒƒã‚¸ç¨®åˆ¥
   */
  function setStatus(id, text, type) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = text;
    el.className = "status-badge " + type;
  }

  // ============================
  // IPã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼‰
  // ============================
  async function fetchIpAddress() {
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      ipAddress = data.ip;
      setStatus("statusIp", "å–å¾—æ¸ˆã¿ âœ…", "success");
    } catch (e) {
      console.error("IPå–å¾—å¤±æ•—:", e);
      ipAddress = "å–å¾—å¤±æ•—";
      setStatus("statusIp", "å–å¾—å¤±æ•—", "error");
    }
  }

  // ============================
  // ä½ç½®æƒ…å ±å–å¾—ï¼ˆPromiseåŒ–ï¼‰
  // ============================
  /**
   * ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±APIã‚’Promiseã§ãƒ©ãƒƒãƒ—
   * @returns {Promise<string>} "ç·¯åº¦,çµŒåº¦" å½¢å¼ã®æ–‡å­—åˆ—
   */
  function getGeolocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("Geolocationéå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶"));
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          resolve(lat + "," + lon);
        },
        (err) => {
          reject(err);
        },
        { enableHighAccuracy: false, timeout: 15000, maximumAge: 60000 }
      );
    });
  }

  // ============================
  // Google Formé€ä¿¡
  // ============================
  /**
   * Google Formã¸éå…¬å¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’POSTé€ä¿¡ã™ã‚‹
   * @param {{ name: string, geo: string, ip: string }} data
   * @returns {Promise<boolean>}
   */
  async function submitToGoogleForm(data) {
    const url = "https://docs.google.com/forms/u/0/d/e/1FAIpQLSewvZcEFe4_0BkxmrYKSefv7eKRvNNDn-_8cdtdjcO1escJ9w/formResponse";

    const formData = new URLSearchParams();
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    formData.append("entry.1695441329", data.name);
    formData.append("entry.2095314548", data.geo);
    formData.append("entry.810078381", data.ip);
    // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    formData.append("fvv", "1");
    formData.append("fbzx", "-837987748540112186");
    formData.append("pageHistory", "0");

    try {
      // no-corsãƒ¢ãƒ¼ãƒ‰: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯èª­ã‚ãªã„ãŒé€ä¿¡è‡ªä½“ã¯æˆåŠŸã™ã‚‹
      await fetch(url, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: formData.toString(),
      });
      return true;
    } catch (e) {
      console.error("Google Formé€ä¿¡ã‚¨ãƒ©ãƒ¼:", e);
      return false;
    }
  }

  // ============================
  // ãƒãƒƒã‚·ãƒ¥é–¢æ•°ï¼ˆã‚·ãƒ¼ãƒ‰ç”Ÿæˆç”¨ï¼‰
  // ============================
  /**
   * æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆç°¡æ˜“djb2ï¼‰
   * @param {string} str
   * @returns {number}
   */
  function simpleHash(str) {
    let hash = 5381;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) + hash + str.charCodeAt(i)) >>> 0;
    }
    return hash;
  }

  // ============================
  // é‹å‹¢ç®—å‡º
  // ============================
  /**
   * ã‚·ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‹ã‚‰é‹å‹¢ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹
   * @param {string} seedStr
   * @returns {{ level: string, emoji: string, message: string, color: { name: string, hex: string }, number: number, direction: string, gradient: string }}
   */
  function generateFortune(seedStr) {
    const hash = simpleHash(seedStr);

    // é‹å‹¢ãƒ¬ãƒ™ãƒ«
    const levels = [
      { level: "å¤§å‰", emoji: "ğŸŒŸ", gradient: "linear-gradient(135deg, #f9ca24, #f0932b)" },
      { level: "å‰",   emoji: "âœ¨", gradient: "linear-gradient(135deg, #6c5ce7, #a29bfe)" },
      { level: "ä¸­å‰", emoji: "ğŸŒ¸", gradient: "linear-gradient(135deg, #fd79a8, #e84393)" },
      { level: "å°å‰", emoji: "ğŸ€", gradient: "linear-gradient(135deg, #00b894, #55efc4)" },
      { level: "æœ«å‰", emoji: "ğŸŒ™", gradient: "linear-gradient(135deg, #74b9ff, #0984e3)" },
      { level: "å‡¶",   emoji: "ğŸŒ§ï¸", gradient: "linear-gradient(135deg, #636e72, #b2bec3)" },
    ];

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é›†
    const messages = {
      "å¤§å‰": [
        "ç´ æ™´ã‚‰ã—ã„é‹æ°—ãŒå·¡ã£ã¦ãã¦ã„ã¾ã™ã€‚\nç©æ¥µçš„ã«è¡Œå‹•ã™ã‚Œã°ã€å¤§ããªæˆæœãŒå¾—ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚",
        "æœ€é«˜ã®ä¸€æ—¥ã«ãªã‚‹äºˆæ„Ÿï¼\næ–°ã—ã„æŒ‘æˆ¦ãŒå¤§ããªå¹¸é‹ã‚’å‘¼ã³è¾¼ã¿ã¾ã™ã€‚",
        "ã‚ãªãŸã®è¼ããŒå‘¨å›²ã‚’ç…§ã‚‰ã™æ—¥ã€‚\nè‡ªä¿¡ã‚’æŒã£ã¦é€²ã‚“ã§ãã ã•ã„ã€‚",
      ],
      "å‰": [
        "ç©ã‚„ã‹ã§è‰¯ã„é‹æ°—ã§ã™ã€‚\næ—¥å¸¸ã®å°ã•ãªå¹¸ã›ã«æ°—ã¥ã‘ã‚‹ä¸€æ—¥ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚",
        "åŠªåŠ›ãŒå®Ÿã‚’çµã¶æ™‚ã€‚\nç¶™ç¶šã—ã¦ããŸã“ã¨ã«å¬‰ã—ã„å¤‰åŒ–ãŒè¨ªã‚Œã¾ã™ã€‚",
        "äººã¨ã®ç¹‹ãŒã‚ŠãŒå¹¸é‹ã‚’é‹ã‚“ã§ãã‚Œã¾ã™ã€‚\næ„Ÿè¬ã®æ°—æŒã¡ã‚’å¿˜ã‚Œãšã«ã€‚",
      ],
      "ä¸­å‰": [
        "ã¾ãšã¾ãšã®é‹å‹¢ã§ã™ã€‚\nç„¦ã‚‰ãšä¸å¯§ã«ç‰©äº‹ã‚’é€²ã‚ã¾ã—ã‚‡ã†ã€‚",
        "ç›´æ„ŸãŒå†´ãˆã‚‹æ—¥ã€‚\nãµã¨æ€ã„ã¤ã„ãŸã“ã¨ã‚’è©¦ã—ã¦ã¿ã‚‹ã¨è‰¯ã„çµæœã«ã€‚",
        "ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸä¸€æ—¥ã€‚\nç„¡ç†ã›ãšè‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã‚’å¤§åˆ‡ã«ã€‚",
      ],
      "å°å‰": [
        "å°ã•ãªå¹¸ã›ãŒè¦‹ã¤ã‹ã‚‹æ—¥ã€‚\nèº«è¿‘ãªäººã¨ã®ä¼šè©±ã«ãƒ’ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚",
        "æ§ãˆã‚ã«éã”ã™ã®ãŒå‰ã€‚\næº–å‚™ã‚„è¨ˆç”»ã‚’ç«‹ã¦ã‚‹ã®ã«æœ€é©ãªæ—¥ã§ã™ã€‚",
        "åœ°é“ãªåŠªåŠ›ãŒå¾Œã§å¤§ããå ±ã‚ã‚Œã¾ã™ã€‚\nä»Šæ—¥ã¯ãã®ç¨®ã¾ãã®æ—¥ã€‚",
      ],
      "æœ«å‰": [
        "å°‘ã—ã ã‘æ…é‡ã«ã€‚\nã§ã‚‚å¿ƒé…ã—ã™ããšã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦éã”ã—ã¾ã—ã‚‡ã†ã€‚",
        "é‹æ°—ã¯ä¸Šå‘ãå‚¾å‘ã€‚\nä»Šã¯åŠ›ã‚’è“„ãˆã‚‹æ™‚æœŸã¨æ‰ãˆã¦ãã ã•ã„ã€‚",
        "æ€ã„ãŒã‘ãªã„ç™ºè¦‹ãŒã‚ã‚‹æ—¥ã€‚\nè¦–ç‚¹ã‚’å¤‰ãˆã¦ã¿ã‚‹ã¨é“ãŒé–‹ã‘ã¾ã™ã€‚",
      ],
      "å‡¶": [
        "ä»Šæ—¥ã¯ç„¡ç†ã‚’ã›ãšã€å¿ƒã¨ä½“ã‚’ä¼‘ã‚ã‚‹æ—¥ã«ã€‚\næ˜æ—¥ã‹ã‚‰ã®é‹æ°—ä¸Šæ˜‡ã«å‚™ãˆã¾ã—ã‚‡ã†ã€‚",
        "æ…é‡ã•ãŒå¤§åˆ‡ãªæ—¥ã€‚\nå¤§ããªæ±ºæ–­ã¯å°‘ã—å…ˆå»¶ã°ã—ã«ã™ã‚‹ã®ãŒå¾—ç­–ã§ã™ã€‚",
        "ãƒ”ãƒ³ãƒã¯ãƒãƒ£ãƒ³ã‚¹ã®ç¨®ã€‚\nå›°é›£ã®ä¸­ã«ã“ãæˆé•·ã®ãã£ã‹ã‘ãŒéš ã‚Œã¦ã„ã¾ã™ã€‚",
      ],
    };

    // ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼
    const colors = [
      { name: "ãƒ¬ãƒƒãƒ‰", hex: "#e74c3c" },
      { name: "ãƒ–ãƒ«ãƒ¼", hex: "#3498db" },
      { name: "ã‚°ãƒªãƒ¼ãƒ³", hex: "#2ecc71" },
      { name: "ãƒ‘ãƒ¼ãƒ—ãƒ«", hex: "#9b59b6" },
      { name: "ã‚ªãƒ¬ãƒ³ã‚¸", hex: "#e67e22" },
      { name: "ãƒ”ãƒ³ã‚¯", hex: "#fd79a8" },
      { name: "ã‚´ãƒ¼ãƒ«ãƒ‰", hex: "#f1c40f" },
      { name: "ã‚·ãƒ«ãƒãƒ¼", hex: "#bdc3c7" },
      { name: "ã‚¿ãƒ¼ã‚³ã‚¤ã‚º", hex: "#1abc9c" },
    ];

    // ãƒ©ãƒƒã‚­ãƒ¼æ–¹è§’
    const directions = ["åŒ—", "åŒ—æ±", "æ±", "å—æ±", "å—", "å—è¥¿", "è¥¿", "åŒ—è¥¿"];

    const levelIndex = hash % levels.length;
    const fortuneData = levels[levelIndex];
    const msgList = messages[fortuneData.level];
    const msgIndex = (hash >>> 4) % msgList.length;
    const colorIndex = (hash >>> 8) % colors.length;
    const luckyNumber = ((hash >>> 12) % 9) + 1;
    const dirIndex = (hash >>> 16) % directions.length;

    return {
      level: fortuneData.level,
      emoji: fortuneData.emoji,
      message: msgList[msgIndex],
      color: colors[colorIndex],
      number: luckyNumber,
      direction: directions[dirIndex],
      gradient: fortuneData.gradient,
    };
  }

  // ============================
  // UIæ“ä½œãƒ˜ãƒ«ãƒ‘ãƒ¼
  // ============================
  function showLoading(show) {
    document.getElementById("loading").classList.toggle("show", show);
  }

  function showResult(show) {
    document.getElementById("resultArea").classList.toggle("show", show);
    document.getElementById("retryBtn").classList.toggle("show", show);
  }

  function setButtonDisabled(disabled) {
    document.getElementById("fortuneBtn").disabled = disabled;
  }

  // ============================
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  // ============================
  async function main() {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const nameInput = document.getElementById("nameInput");
    const name = nameInput.value.trim();
    const validationMsg = document.getElementById("validationMsg");

    if (!name) {
      validationMsg.classList.add("show");
      nameInput.focus();
      return;
    }
    validationMsg.classList.remove("show");

    // UIåˆ‡ã‚Šæ›¿ãˆ
    setButtonDisabled(true);
    showResult(false);
    showLoading(true);

    // ä½ç½®æƒ…å ±å–å¾—
    let geoString = "å–å¾—å¤±æ•—";
    setStatus("statusGeo", "å–å¾—ä¸­...", "pending");
    try {
      geoString = await getGeolocation();
      setStatus("statusGeo", "å–å¾—æ¸ˆã¿ âœ…", "success");
    } catch (e) {
      console.warn("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—:", e);
      if (e.code === 1) {
        geoString = "ä½ç½®æƒ…å ±: æ‹’å¦ã•ã‚Œã¾ã—ãŸ";
        setStatus("statusGeo", "æ‹’å¦", "error");
      } else {
        geoString = "ä½ç½®æƒ…å ±: å–å¾—å¤±æ•—";
        setStatus("statusGeo", "å–å¾—å¤±æ•—", "error");
      }
    }

    // IPãŒã¾ã å–å¾—ä¸­ãªã‚‰å¾…æ©Ÿ
    if (ipAddress === null) {
      await fetchIpAddress();
    }

    // Google Formã¸é€ä¿¡
    setStatus("statusSubmit", "é€ä¿¡ä¸­...", "pending");
    const submitOk = await submitToGoogleForm({
      name: name,
      geo: geoString,
      ip: ipAddress || "å–å¾—å¤±æ•—",
    });

    if (submitOk) {
      setStatus("statusSubmit", "é€ä¿¡å®Œäº† âœ…", "success");
    } else {
      setStatus("statusSubmit", "é€ä¿¡å¤±æ•—", "error");
    }

    // é‹å‹¢ã‚’ç®—å‡º
    const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
    const seedStr = name + today + geoString + (ipAddress || "");
    const fortune = generateFortune(seedStr);

    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰çµæœè¡¨ç¤ºï¼ˆæ¼”å‡ºï¼‰
    await new Promise((r) => setTimeout(r, 800));

    // çµæœã‚’DOMã«åæ˜ 
    document.getElementById("fortuneEmoji").textContent = fortune.emoji;
    const levelEl = document.getElementById("fortuneLevel");
    levelEl.textContent = fortune.level;
    levelEl.style.background = fortune.gradient;
    levelEl.style.webkitBackgroundClip = "text";
    levelEl.style.webkitTextFillColor = "transparent";
    levelEl.style.backgroundClip = "text";

    document.getElementById("fortuneMessage").textContent = fortune.message;

    // ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ï¼ˆãƒ‰ãƒƒãƒˆä»˜ãï¼‰
    document.getElementById("luckyColor").innerHTML =
      '<span class="color-dot" style="background:' + fortune.color.hex + '"></span>' + fortune.color.name;

    document.getElementById("luckyNumber").textContent = fortune.number;
    document.getElementById("luckyDirection").textContent = fortune.direction;

    // UIåˆ‡ã‚Šæ›¿ãˆ
    showLoading(false);
    showResult(true);
    setButtonDisabled(false);
  }

  // ============================
  // ãƒªãƒˆãƒ©ã‚¤
  // ============================
  function retry() {
    showResult(false);
    document.getElementById("nameInput").value = "";
    document.getElementById("nameInput").focus();
    setStatus("statusGeo", "å¾…æ©Ÿä¸­", "pending");
    setStatus("statusSubmit", "æœªé€ä¿¡", "pending");
  }

  // ============================
  // Enterã‚­ãƒ¼å¯¾å¿œ
  // ============================
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("nameInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        main();
      }
    });
  });

  // ============================
  // åˆæœŸåŒ–: ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«IPå–å¾—
  // ============================
  fetchIpAddress();
</script>

</body>
</html>